---
description: "Monitor YubiKey health including PIN retry counters, certificate expiration, firmware versions, and configuration status"
allowed-tools: ["Read", "Bash(ykman:list)", "Bash(ykman:info)", "Bash(ykman:piv:info)", "Bash(ykman:openpgp:info)", "Bash(ykman:fido:info)", "Bash(ykman:oath:list)"]
author: "YubiKey Tools Team"
version: "1.0"
---

# YubiKey Health Check

## Purpose
Proactively monitor YubiKey health and security status to prevent lockouts, identify expiring certificates, validate firmware compatibility, and ensure optimal configuration. This is a **read-only** monitoring operation that never modifies YubiKey state.

## Safety Level
**SAFE** - Read-only operations, no YubiKey modifications

## Prerequisites
- YubiKey connected
- YubiKey Manager (ykman) installed
- Read access to test device registry (optional)

## Health Check Steps

### 1. Enumerate Connected YubiKeys

```bash
# List all connected devices
!ykman list

# Count devices
!ykman list | wc -l
```

### 2. Basic Device Information

For each connected YubiKey:

```bash
# Get full device information
!ykman info

# Get info in JSON format
!ykman info --json 2>/dev/null
```

### 3. PIN Retry Counter Check

**CRITICAL**: Monitor PIN retry counters to prevent lockouts

```bash
# PIV PIN retry counter (should be 3/3)
!ykman piv info 2>/dev/null | grep "PIN tries remaining"

# OpenPGP PIN retry counter
!ykman openpgp info 2>/dev/null | grep "PIN tries remaining"

# FIDO2 PIN retry counter (should be 8/8)
!ykman fido info 2>/dev/null | grep "PIN retries"
```

### 4. Certificate Expiration Check

```bash
# Check PIV certificates
!ykman piv info 2>/dev/null

# Extract certificate details
!ykman piv certificates export 9a - 2>/dev/null | openssl x509 -noout -dates 2>/dev/null

# Check all PIV slots
for slot in 9a 9c 9d 9e; do
  echo "Checking slot $slot..."
  ykman piv certificates export $slot - 2>/dev/null | openssl x509 -noout -subject -dates 2>/dev/null
done
```

### 5. Firmware Version Validation

```bash
# Get firmware version
!ykman info | grep "Firmware version"

# Compare against compatibility matrix
@Read: docs/compatibility.md
```

### 6. Application Status Check

```bash
# Check enabled applications
!ykman info | grep "Applications"

# PIV applet status
!ykman piv info 2>/dev/null

# FIDO2 applet status
!ykman fido info 2>/dev/null

# OATH applet status
!ykman oath accounts list 2>/dev/null | wc -l

# OpenPGP applet status
!ykman openpgp info 2>/dev/null
```

### 7. Touch Policy Validation

```bash
# Check PIV touch policies
!ykman piv info 2>/dev/null | grep -i "touch"

# Check OpenPGP touch policies
!ykman openpgp info 2>/dev/null | grep -i "touch"
```

### 8. Identify Device Classification

```bash
# Check if device is in test registry
@Read: tests/fixtures/TEST_DEVICES.md

# Compare serial number
# Flag if production device needs attention
```

### 9. Generate Health Report

Create **YUBIKEY_HEALTH_REPORT.md**:

```markdown
# YubiKey Health Report

**Report Date**: [ISO 8601 timestamp]
**Generated By**: YubiKey Health Check v1.0
**Devices Scanned**: [N]

---

## Executive Summary

| Metric | Status | Details |
|--------|--------|---------|
| Devices Found | [N] | [List serials] |
| Critical Issues | [N] | ğŸ”´ Require immediate attention |
| Warnings | [N] | ğŸŸ¡ Should address soon |
| Healthy | [N] | ğŸŸ¢ No issues detected |

**Overall Health**: ğŸŸ¢ HEALTHY / ğŸŸ¡ ATTENTION NEEDED / ğŸ”´ CRITICAL ISSUES

---

## Device Health Details

### Device #1: Serial [XXXXXX]

**Basic Information**:
- Model: YubiKey 5 NFC
- Firmware: 5.7.1
- Form Factor: USB-A with NFC
- Classification: ğŸ§ª Test Device / âš ï¸  Production Device

**Health Status**: ğŸŸ¢ HEALTHY / ğŸŸ¡ WARNINGS / ğŸ”´ CRITICAL

#### PIN Retry Counters

| Application | Current | Maximum | Status |
|-------------|---------|---------|--------|
| PIV PIN | 3 | 3 | ğŸŸ¢ Full retries |
| PIV PUK | 3 | 3 | ğŸŸ¢ Full retries |
| OpenPGP PIN | 3 | 3 | ğŸŸ¢ Full retries |
| OpenPGP Admin PIN | 3 | 3 | ğŸŸ¢ Full retries |
| FIDO2 PIN | 8 | 8 | ğŸŸ¢ Full retries |

**Issues**:
- ğŸ”´ CRITICAL: PIV PIN only 1 retry remaining (lockout imminent!)
- ğŸŸ¡ WARNING: FIDO2 PIN at 3/8 retries
- ğŸŸ¢ OK: All retry counters at maximum

#### Certificate Status

| Slot | Subject | Expiration | Days Left | Status |
|------|---------|------------|-----------|--------|
| 9a (Auth) | CN=John Doe | 2026-12-31 | 365 | ğŸŸ¢ Valid |
| 9c (Sign) | CN=John Doe | 2025-12-15 | 30 | ğŸŸ¡ Expiring soon |
| 9d (Encrypt) | - | - | - | âšª Empty |
| 9e (Card Auth) | CN=John Doe | 2024-11-20 | -1 | ğŸ”´ EXPIRED |

**Issues**:
- ğŸ”´ CRITICAL: Slot 9e certificate expired [X] days ago
- ğŸŸ¡ WARNING: Slot 9c certificate expires in [X] days
- ğŸŸ¢ OK: All certificates valid

#### Firmware Status

- **Current Firmware**: 5.7.1
- **Latest Available**: 5.7.1
- **Status**: ğŸŸ¢ Up to date / ğŸŸ¡ Update available / ğŸ”´ EOL firmware

**Compatibility**:
- RSA 4096: âœ… Supported
- ECC P-384: âœ… Supported
- Ed25519: âœ… Supported
- FIDO2 Resident Keys: âœ… Supported

#### Application Configuration

**PIV**:
- Status: Enabled
- Keys Generated: 2/4 slots
- Management Key: Custom / Default
- Touch Policy: Cached (9a), Always (9c)

**FIDO2**:
- Status: Enabled
- PIN Configured: Yes
- Resident Credentials: 3
- Always Require UV: No

**OATH**:
- Status: Enabled
- Password Protected: No
- Total Credentials: 12
- TOTP: 10, HOTP: 2

**OpenPGP**:
- Status: Enabled
- Keys Present: Signature, Encryption, Authentication
- Touch Policy: All keys require touch
- Attestation: Available

#### Touch Policy Configuration

| Operation | Touch Required | Status |
|-----------|----------------|--------|
| PIV 9a | CACHED | ğŸŸ¡ Consider ALWAYS |
| PIV 9c | ALWAYS | ğŸŸ¢ Secure |
| PIV 9d | NEVER | âšª No key |
| PIV 9e | NEVER | âšª No key |
| OpenPGP Sign | ALWAYS | ğŸŸ¢ Secure |
| OpenPGP Encrypt | ALWAYS | ğŸŸ¢ Secure |
| OpenPGP Auth | ALWAYS | ğŸŸ¢ Secure |

**Recommendations**:
- ğŸŸ¡ Consider setting touch policy to ALWAYS for PIV 9a
- ğŸŸ¢ Current touch policies are secure

---

## Device #2: Serial [XXXXXX]

[Repeat structure for each device]

---

## Critical Issues Summary

### Immediate Action Required ğŸ”´

1. **Device [serial]**: PIV PIN at 1/3 retries
   - **Risk**: One more failed attempt will lock the device
   - **Action**: Reset PIN immediately or unlock with PUK
   - **Command**: `ykman piv access change-pin`

2. **Device [serial]**: Certificate expired in slot 9e
   - **Risk**: Authentication may fail
   - **Action**: Generate new certificate or remove old one
   - **Command**: `ykman piv certificates generate 9e`

### Warnings ğŸŸ¡

1. **Device [serial]**: Certificate expiring in 30 days (slot 9c)
   - **Action**: Renew certificate before expiration
   - **Timeline**: Complete by [date]

2. **Device [serial]**: FIDO2 PIN at 3/8 retries
   - **Action**: Reset PIN if forgotten
   - **Timeline**: Address within 1 week

### Recommendations ğŸŸ¢

1. **Device [serial]**: Firmware update available (5.4.3 â†’ 5.7.1)
   - **Benefit**: New features, security improvements
   - **Action**: Schedule firmware update
   - **Note**: Requires YubiKey removal and physical device update

2. **Touch policy optimization**: Consider ALWAYS policy for all operations
   - **Benefit**: Maximum security
   - **Trade-off**: More user interaction

---

## Health Trends

### Historical Comparison

| Metric | Previous | Current | Trend |
|--------|----------|---------|-------|
| Devices | 3 | 3 | â¡ï¸ Stable |
| Critical Issues | 1 | 0 | â¬‡ï¸ Improved |
| Warnings | 3 | 2 | â¬‡ï¸ Improved |
| Avg PIN Retries | 95% | 98% | â¬†ï¸ Better |
| Expired Certs | 2 | 0 | â¬‡ï¸ Improved |

**Trend**: ğŸ“ˆ Improving / â¡ï¸ Stable / ğŸ“‰ Declining

---

## Recommended Actions

### Priority 1 (Immediate - Today)
- [ ] Reset PIN on device [serial] (1 retry remaining)
- [ ] Renew expired certificate on device [serial] slot 9e
- [ ] Back up device [serial] before any changes

### Priority 2 (High - This Week)
- [ ] Renew certificate expiring in 30 days
- [ ] Reset FIDO2 PIN on device [serial] (low retries)
- [ ] Update firmware on device [serial]

### Priority 3 (Medium - This Month)
- [ ] Review and optimize touch policies
- [ ] Schedule regular health checks (weekly)
- [ ] Document device configurations

### Priority 4 (Low - Future)
- [ ] Standardize configuration across devices
- [ ] Implement automated monitoring
- [ ] Create backup/restore procedures

---

## Next Health Check

**Recommended**: [Date, 1 week from now]
**Frequency**: Weekly for devices with warnings, monthly for healthy devices

---

## Maintenance Schedule

- **Daily**: Check critical devices (production systems)
- **Weekly**: Run health check on all devices
- **Monthly**: Review trends and optimize configurations
- **Quarterly**: Firmware updates and security reviews
- **Annually**: Replace devices > 5 years old

---

**Report Generated**: [Timestamp]
**Report Valid Until**: [7 days from generation]
**Next Check Due**: [Date]
```

### 10. Display Health Check Summary

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          YUBIKEY HEALTH CHECK COMPLETE             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEVICES SCANNED: [N]

OVERALL HEALTH: ğŸŸ¢ HEALTHY / ğŸŸ¡ ATTENTION NEEDED / ğŸ”´ CRITICAL

CRITICAL ISSUES (Immediate Action):
  ğŸ”´ Device [serial]: PIN at 1/3 retries (lockout risk!)
  ğŸ”´ Device [serial]: Certificate expired (slot 9e)

WARNINGS (Address Soon):
  ğŸŸ¡ Device [serial]: Certificate expiring in 30 days
  ğŸŸ¡ Device [serial]: FIDO2 PIN at 3/8 retries
  ğŸŸ¡ Device [serial]: Firmware update available

HEALTHY DEVICES:
  ğŸŸ¢ Device [serial]: All checks passed
  ğŸŸ¢ Device [serial]: All checks passed

PIN RETRY STATUS:
  Full Retries: [N] devices
  Partial Retries: [N] devices
  Critical (1-2 left): [N] devices
  Locked: [N] devices

CERTIFICATE STATUS:
  Valid: [N] certificates
  Expiring < 30 days: [N] certificates
  Expired: [N] certificates

FIRMWARE STATUS:
  Up to date: [N] devices
  Updates available: [N] devices
  EOL firmware: [N] devices

Full Report: YUBIKEY_HEALTH_REPORT.md

NEXT ACTIONS:
  Â» Address [N] critical issues immediately
  Â» Review [N] warnings this week
  Â» Schedule next health check: [date]

Run this check weekly to prevent lockouts and security issues.
```

## Key Features

- **Proactive Monitoring**: Catches issues before they become problems
- **PIN Lockout Prevention**: Critical alert when retry counters low
- **Certificate Management**: Tracks expiration dates
- **Firmware Tracking**: Validates compatibility and recommends updates
- **Trend Analysis**: Historical comparison of device health
- **Actionable Recommendations**: Prioritized action items
- **Comprehensive Coverage**: All applications (PIV, FIDO2, OATH, OpenPGP)
- **Safe Operation**: Read-only, never modifies YubiKey state

## When to Use /yubikey-health-check

### Regular Monitoring
- **Weekly**: For production YubiKeys
- **Monthly**: For backup/test YubiKeys
- **After configuration changes**: Verify health post-change
- **Before important operations**: Ensure device ready

### Specific Scenarios
- Authentication failures (check PIN retry counters)
- Planning certificate renewal (check expiration dates)
- Firmware compatibility questions
- Device inventory and audit
- Troubleshooting device issues
- Before backup/restore operations

### Integration with Workflows
```bash
# Daily morning check
/yubikey-health-check

# Before critical operations
/yubikey-health-check
/yubikey-backup  # If warnings found
[perform operation]

# After configuration
[configuration changes]
/yubikey-health-check  # Verify health

# CI/CD integration
/yubikey-health-check
# Fail build if critical issues found
```

## Health Check Schedule

### Recommended Frequencies

**Production Devices**:
- Daily: High-security environments
- Weekly: Standard production use
- After each use: Maximum security

**Development/Test Devices**:
- Weekly: Active development
- Monthly: Stable/backup devices
- Before testing: Integration test preparation

**Personal Devices**:
- Weekly: Regular use
- Monthly: Occasional use
- Before travel: Ensure operational

## Alert Thresholds

### Critical (ğŸ”´)
- PIN retry counter â‰¤ 2
- Certificate expired
- Firmware EOL (End of Life)
- Device locked

### Warning (ğŸŸ¡)
- PIN retry counter â‰¤ 5
- Certificate expiring < 30 days
- Firmware update available
- Touch policy not optimal

### Info (ğŸŸ¢)
- PIN retry counters full
- Certificates valid > 90 days
- Firmware up to date
- Configuration optimal

## Best Practices

1. **Regular Checks**: Don't wait for problems - check weekly
2. **Act on Warnings**: Address yellow warnings before they become red
3. **Document Baseline**: Save initial health report for comparison
4. **Trend Monitoring**: Track metrics over time
5. **Automate Alerts**: Set up automated health checks in CI/CD
6. **Team Awareness**: Share health reports with team
7. **Emergency Planning**: Know rollback procedures before issues
8. **Backup Before Changes**: Always backup before addressing issues

## Troubleshooting

### Low PIN Retry Counters
**Problem**: PIN at 1-2 retries
**Solutions**:
1. If you remember PIN: Change PIN immediately
2. If PIN forgotten: Use PUK to unlock and reset PIN
3. If PUK also forgotten: Factory reset (data loss!)

**Commands**:
```bash
# Change PIN (if remembered)
ykman piv access change-pin

# Unlock with PUK (if PIN forgotten)
ykman piv access unblock-pin

# Factory reset (LAST RESORT - data loss!)
ykman piv reset
```

### Expired Certificates
**Problem**: Certificate past expiration date
**Solutions**:
1. Generate new certificate
2. Import renewed certificate
3. Remove expired certificate if unused

**Commands**:
```bash
# Generate new certificate
ykman piv certificates generate 9a

# Import renewed certificate
ykman piv certificates import 9a cert.pem

# Delete expired certificate
ykman piv certificates delete 9a
```

### Firmware Issues
**Problem**: Outdated or EOL firmware
**Solutions**:
1. Check Yubico website for firmware updates
2. Note: Firmware updates require physical device access
3. Cannot downgrade firmware
4. Plan for device replacement if EOL

## Security Considerations

- **Read-Only**: This command never modifies YubiKey state
- **No Sensitive Data**: Health checks don't expose private keys or PINs
- **Safe Automation**: Can be run in CI/CD without risk
- **Public Data Only**: Only retrieves publicly available information
- **No Authentication Required**: Most checks don't need PIN/PUK
- **Audit Trail**: Generate reports for compliance and auditing

## Performance

- **Fast**: Completes in < 30 seconds per device
- **Lightweight**: No heavy cryptographic operations
- **Scalable**: Can check multiple devices in parallel
- **Offline**: Works without internet connection
- **Low Impact**: Doesn't affect device performance or lifetime

---

**Command Version**: 1.0
**Last Updated**: 2025-11-21
**Maintained By**: YubiKey Tools Team
